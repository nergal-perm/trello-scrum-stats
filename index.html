<!DOCTYPE <!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Sample trello queries</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 
    <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
    <script src="main.js"></script>
    -->
</head>
<body>

    <div id="testDiv">
        <h1>Test Trello queries</h1>

        <form>
            <div><select id="sprintSelect"></select></div>
            <div><button type="button" onclick="loadSprintCardsFor()">Получить данные</button></div>
        </form>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        // TODO: I need to know date span of the sprint being analyzed
        var SPRINT_BEGIN_DATE = treatAsUTC("04/08/2018");
        const CUSTOM_FIELD_SPRINT_ID = "5aceccf6b9f19cf7c6ecac99";
        const CUSTOM_FIELD_SPRINT_NUMBER = "5acdb5b1bc91f1d6ebe4bc8b";
        const CUSTOM_FIELD_SPRINT_START_DATE = "5acdb5bb4b208d21a7fc36c5";
        const CUSTOM_FIELD_SPRINT_END_DATE = "5acdb5c2c97abe259d435942";

        var apiData = {};
        var sprints = [];

        $(document).ready(function() {
            loadConfig();
        });

        function loadConfig() {
            $.getJSON( "assets/config.json", function( data ) {
                $.each( data, function( key, val ) {
                    apiData[key] = val;
                });
                getAllTheSprints();
            });
        }

        function getAllTheSprints() {
            var url = "https://api.trello.com/1/lists/" + apiData.sprintsListID +
            "/cards?key=" + apiData.apiKey + "&token=" + apiData.apiToken + "&fields=name,id&customFieldItems=true";
            $.getJSON(url, function (data) {
                var items = [];
                $.each(data, function(item) {
                    var sprint = {};
                    data[item].customFieldItems.forEach(function(customField) {
                        switch(customField.idCustomField) {
                            case CUSTOM_FIELD_SPRINT_ID: 
                                sprint.id = customField.value.text;
                                break;
                            case CUSTOM_FIELD_SPRINT_NUMBER:
                                sprint.number = customField.value.number;
                                break;
                            case CUSTOM_FIELD_SPRINT_START_DATE:
                                sprint.startDate = treatAsUTC(customField.value.date);
                                break;
                            case CUSTOM_FIELD_SPRINT_END_DATE:
                                sprint.endDate = treatAsUTC(customField.value.date);
                                break;                             
                        }
                    });
                    sprint.name = data[item].name;
                    if (sprint.id !== undefined) {
                        items.push( "<option value='" + sprint.id + "'>" + sprint.name + "</option>" );
                    }

                    sprints.push(sprint);
                });
                $( "#sprintSelect").html(items.join(""));
            });
        }

        function loadSprintCardsFor() {
            var sprintId = $("#sprintSelect").val();
            var sprint = getSprintById(sprintId);
            if (sprint === null) {  
                alert("Sprint not found");
                return;
            }
            SPRINT_BEGIN_DATE = sprint.startDate;
            sprintCustomFields = getCustomFieldsFor(sprint.id);
            var url = "https://api.trello.com/1/boards/" + sprintId +
            "/cards?key=" + apiData.apiKey + "&token=" + apiData.apiToken + "&fields=name,dueComplete,due,labels&customFieldItems=true";
            $.getJSON(url, function (data) {
                var cards = [];
                var sprintPlannedPoints = 0;
                var sprintEstimatedPoints = 0;
                var sprintRealPoints = 0;
                var burnout = createBurnoutTemplate();
                $.each(data, function(index) {
                    var card = createCardFrom(data[index], sprintCustomFields);
                    if (card.type === "Task") {
                        if (card.isPlanned) {
                            sprintPlannedPoints += card.pointsEstimated;
                        }
                        sprintEstimatedPoints += card.pointsEstimated;
                        burnout[card.dayCreated].realPointsLeft += card.pointsEstimated;
                        if (card.isCompleted) {
                            burnout[card.dayCompleted].realHoursDone += card.hoursReal;
                            burnout[card.dayCompleted].realPointsDone += card.pointsEstimated;
                            sprintRealPoints += card.pointsEstimated;
                        }
                    } else if (card.type !== undefined && card.type !== "Story"){
                        cards.push("<li>" + card.name + ", type:" + card.type + "</li>");
                    }
                    
                });
                calculateBurnoutStats(burnout, sprintPlannedPoints);
                console.log(burnout);
                $("<p/>", {
                    html: "Очков на спринт (план): <strong>" + sprintPlannedPoints.toFixed(2) + "</strong><br/>" +
                          "Всего очков на спринт: <strong>" + sprintEstimatedPoints.toFixed(2) + "</strong><br/>" +
                          "Реализовано очков: <strong>" + sprintRealPoints.toFixed(2) + "</strong>"
                    }).appendTo( "#testDiv");
                $( "<ul/>", {
                    "class": "cards-list",
                    html: cards.join( "" )
                }).appendTo( "#testDiv" );
                
            });            
        }

        function getCustomFieldsFor(sprintId) {
            var url = "https://api.trello.com/1/boards/" + sprintId +
            "/customFields?key=" + apiData.apiKey + "&token=" + apiData.apiToken;
            var result = {};
            $.getJSON(url, function (data) {
                $.each(data, function(index) {
                    switch(data[index].name) {
                        case "Created": 
                            result.created = data[index].id;
                            break;
                        case "Story Points":
                            result.storyPoints = data[index].id;
                            break;
                        case "Scrum Type":
                            result.scrumType = data[index].id;
                            data[index].options.forEach(function(option) {
                                result[option.id] = option.value.text;
                            });
                            break;
                    }
                });
            });
            return result;
        }

        function createCardFrom(cardData, sprintCustomFields) {
            if (typeof(cardData) === "object") {
                var card = {};

                var estHoursRegex = /\(([\d|\.]*)\)/g;
                if (cardData.name.search(estHoursRegex) > -1) {
                    card.type = "Task";
                    var result = estHoursRegex.exec(cardData.name);
                    card.hoursEstimated = Number.parseFloat(result[1]);
                    cardData.name = cardData.name.replace(estHoursRegex, "").trim();
                }

                var realHoursRegex = /\[([\d|\.]*)\]/g;
                if (cardData.name.search(realHoursRegex) > -1) {
                    var result = realHoursRegex.exec(cardData.name);
                    card.hoursReal = Number.parseFloat(result[1]);;
                    cardData.name = cardData.name.replace(realHoursRegex, "").trim();
                }

                card.name = cardData.name;
                card.isCompleted = !!cardData.dueComplete;
                if (card.isCompleted === true) {
                    card.dayCompleted = getDaysBetween(treatAsUTC(cardData.due), SPRINT_BEGIN_DATE);
                }
                card.isPlanned = true;
                cardData.customFieldItems.forEach(function(item) {
                    switch(item.idCustomField) {
                        case sprintCustomFields.created:
                            card.isPlanned = false;
                            card.dayCreated = getDaysBetween(treatAsUTC(item.value.date), SPRINT_BEGIN_DATE);
                            break;
                        case sprintCustomFields.storyPoints:
                            card.pointsEstimated = Number.parseFloat(item.value.number);
                            break;
                        case sprintCustomFields.scrumType:
                            card.type = sprintCustomFields[item.idValue];
                            break;
                    }
                });
                if(card.isPlanned) {
                    card.dayCreated = 0;
                }
 
                return card;
            } else {
                return null;
            }
        }

        function createBurnoutTemplate() {
            var result = new Array(7);
            for (var i=0; i<7; i++) {
                result[i] = {
                    "idealPointsLeft": 0,
                    "realPointsLeft": 0,
                    "realPointsDone": 0,
                    "realHoursDone": 0
                };
            }
            return result;
        }

        function getDaysBetween(date1, date2) {
            var millisecondsPerDay = 24 * 60 * 60 * 1000;
            return Math.floor((date1 - date2) / millisecondsPerDay);            
        }

        function calculateBurnoutStats(burnout, sprintPlannedPoints) {
            var idealBurnoutPerDay = sprintPlannedPoints / burnout.length;
            burnout.forEach(function(day, index, array) {
                day.idealPointsLeft = Math.round(sprintPlannedPoints - idealBurnoutPerDay * (index + 1));
                if (index === 0) {
                    day.realPointsLeft = day.realPointsLeft - day.realPointsDone;
                } else {
                    day.realPointsLeft = array[index-1].realPointsLeft + day.realPointsLeft - day.realPointsDone;
                    day.realPointsDone += array[index-1].realPointsDone;
                    day.realHoursDone += array[index-1].realHoursDone;
                }
            });
            return burnout;
        }

        function treatAsUTC(date) {
            var result = new Date(Date.parse(date));
            result.setMinutes(result.getMinutes() - result.getTimezoneOffset());
            return result;
        }

        function getSprintById(sprintId) {
            var result = null;
            sprints.forEach(function(sprint) {
                if (sprint.id === sprintId) {
                    result = sprint;
                }
            });
            return result;
        }
    </script>
</body>
</html>